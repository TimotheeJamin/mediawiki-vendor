!! Version 2

!! article
Template:1x
!! text
{{{1}}}
!! endarticle

# TODO: add a test for T295168 when tackling it

#
# Tests of the handling of the Translate extension
#

!! test
Continue to serialize the old translate 2.3.0 html
!! options
parsoid=html2wt
!! html/parsoid
<p><span typeof="mw:Extension/translate" about="#mwt2" data-mw='{"name":"translate","attrs":{},"body":{"extsrc":"foo"}}'>foo</span></p><p>

foo</p><pre typeof="mw:Extension/translate" about="#mwt4" data-mw='{"name":"translate","attrs":{},"body":{"extsrc":"\n bar\n"}}'>bar
</pre><p>baz</p>
<p>foo</p>
<pre>bar</pre>
<p>baz</p>
!! wikitext
<translate>foo</translate>

foo<translate>
 bar
</translate>baz
foo
 bar
baz
!! end

!! test
Whole content between translate tags
!! wikitext
<translate>
==Title==

Let's have some text.
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<h2 id="Title" data-parsoid='{"dsr":[12,23,2,2,1,1]}'>Title</h2>

<p data-parsoid='{"dsr":[25,46,0,0]}'>Let's have some text.</p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[45,57]}'/>
!! end

!! test
Inline translate tags
!! wikitext
Some text <translate>with some translated content</translate> inline.
!! html/parsoid
<p>Some text <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[10,21]}' />with some translated content<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[49,61]}'/> inline.</p>
!! end

!! test
Template inside a translate tag should not make a difference on its handling
!! wikitext
<translate>{{1x|
== Title ==
}}

Let's have some text.
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/><span about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"\n== Title ==\n"}},"i":0}}]}'>
</span><h2 about="#mwt1" id="Title">Title</h2><span about="#mwt1">
</span>

<p>Let's have some text.</p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[55,67]}'/>
!! end

!! test
Two inline translate tags should have different rangeIds
!! wikitext
Some inline <translate>text</translate> followed by <translate>some more text</translate> inline
!! html/parsoid
<p>Some inline <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[12,23]}'/>text<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[27,39]}'/> followed by <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa1","extendedRange":false,"wtOffsets":[52,63]}'/>some more text<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[77,89]}'/> inline</p>
!! end

!! test
Two translate tags on new lines should have different rangeIds
!! wikitext
Some  
<translate>
text
</translate> 
followed by 
<translate>
some more text
</translate>
to translate
!! html/parsoid
<p>Some  
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[7,18]}'/>
text
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[24,36]}'/> 
followed by 
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa1","extendedRange":false,"wtOffsets":[51,62]}'/>
some more text
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[78,90]}'/>
to translate</p>
!! end

!! test
Name attribute in tvar tags should be added to the meta tag
!! wikitext
Some text <translate>with some <tvar name="plop">untranslated</tvar> content</translate> inline.
!! html/parsoid
<p>Some text <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[10,21]}'/>with some <meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"plop"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[31,49]}'/>untranslated<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[61,68]}'/> content<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[76,88]}'/> inline.</p>
!! end

!! test
Annotation wrapping an entire paragraph should be nested inside the paragraph
!! wikitext
foo

<translate>bar</translate>

<translate>baz</translate>
!! html/parsoid
<p>foo</p>

<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[5,16]}'/>bar<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[19,31]}'/></p>

<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa1","extendedRange":false,"wtOffsets":[33,44]}'/>baz<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[47,59]}'/></p>
!! end

!! test
Two paragraphs between translate tags should roundtrip without duplicating the tags (DSRs are adjusted correctly)
!! wikitext
<translate>plop

Let's have some text.</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-parsoid='{"dsr":[0,11,null,null]}' data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/><p data-parsoid='{"dsr":[11,15,0,0]}'>plop</p>

<p data-parsoid='{"dsr":[17,38,0,0]}'>Let's have some text.</p><meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[38,50,null,null]}' data-mw='{"wtOffsets":[38,50]}'/>
!! end

!! test
Start translate tag at the beginning of a paragraph and end within <i> should extend to the end of <i> but not the whole paragraph
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
<translate>This should ''fail</translate> miserably'' ... let's fix it
!! html/parsoid here
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[0,11]}'/>This should <i>fail miserably</i><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[29,41]}'/> ... let's fix it</p>
!! end

!! test
End translate tag at the end of a paragraph and beginning within <i> should extend to the end of <i> but not the whole paragraph
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
This should ''fail <translate>miserably'' ... let's fix it</translate>
!! html/parsoid here
<p>This should <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[19,30]}'/><i>fail miserably</i> ... let's fix it<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[58,70]}'/></p>
!! end

!! test
Meta merging with annotations/template should not happen
!! wikitext
<translate>{{1x|stuff}}</translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/><span about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"stuff"}},"i":0}}]}'>stuff</span><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[23,35]}'/></p>
!! end

!! test
Meta merging with template/annotation is fine
!! wikitext
{{1x|<translate>stuff</translate>}}
!! html/parsoid
<p><meta typeof="mw:Transclusion mw:Annotation/translate" about="#mwt1" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"&lt;translate>stuff&lt;/translate>"}},"i":0}}],"rangeId":"mwa0"}'/><span about="#mwt1">stuff</span><meta typeof="mw:Annotation/translate/End" about="#mwt1" data-mw='{"rangeId":"mwa0"}'/></p>
!! end

!! test
Translate in a link description
!! wikitext
[[Board elections/2004/Vote interface translation|<translate>Vote interface</translate>]]
!! html/parsoid
<p><a rel="mw:WikiLink" href="./Board_elections/2004/Vote_interface_translation" title="Board elections/2004/Vote interface translation" class="new"><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[50,61]}'/>Vote interface<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[75,87]}'/></a></p>
!! end

!! test
Translate with a tvar for links
!! wikitext
<translate>[[<tvar name="1">Special:MyLanguage/Category:Categories</tvar>|See the category of categories]].</translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa1","extendedRange":false,"wtOffsets":[0,11]}'/><a typeof="mw:ExpandedAttrs mw:Annotation/tvar" about="#mwt1" rel="mw:WikiLink" href="./Special:MyLanguage/Category:Categories" title="Special:MyLanguage/Category:Categories" class="new" data-parsoid='{"stx":"piped","a":{"href":"./Special:MyLanguage/Category:Categories"},"sa":{"href":"&lt;tvar name=\"1\">Special:MyLanguage/Category:Categories&lt;/tvar>"}}' data-mw='{"attribs":[[{"txt":"href"},{"html":"&lt;meta typeof=\"mw:Annotation/tvar\" data-parsoid=&apos;{\"dsr\":[13,28,null,null]}&apos; data-mw=&apos;{\"attrs\":{\"name\":\"1\"},\"rangeId\":\"mwa0\",\"extendedRange\":false,\"wtOffsets\":[13,28]}&apos;/>Special:MyLanguage/Category:Categories&lt;meta typeof=\"mw:Annotation/tvar/End\" data-parsoid=&apos;{\"dsr\":[66,73,null,null]}&apos; data-mw=&apos;{\"wtOffsets\":[66,73]}&apos;/>"}]]}'>See the category of categories</a>.<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[107,119]}'/></p>
!! end

!! test
Attributes without value should be transferred to and back from the meta tag
!! wikitext
<translate nowrap>some stuff</translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"attrs":{"nowrap":""},"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,18]}'/>some stuff<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[28,40]}'/></p>
!! end

!! test
Annotation open tag in fosterable position should expand the range to the entire table
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
{|
|table
|with
|-
<translate>
|some
|content</translate>
|-
|translate
|one line
|}
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[19,30]}'/>
<table>
<tbody><tr><td>table</td>
<td data-parsoid>with</td></tr>
<tr data-parsoid='{"startTagSrc":"|-"}'>
<td>some</td>
<td>content</td></tr>
<tr data-parsoid='{"startTagSrc":"|-"}'>
<td>translate</td>
<td>one line</td></tr>
</tbody></table>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[45,57]}' />
!! end

!! test
Translate in the middle of fostered content should extend to the whole range, including fostered content
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
{|
foo
<translate>bar</translate>
|-
|baz
|}
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-parsoid='{"wasMoved":true}' data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[7,18]}'/><p data-parsoid='{"fostered":true,"autoInsertedEnd":true,"autoInsertedStart":true}'>
foo
bar</p><table>
<tbody><tr data-parsoid='{"startTagSrc":"|-"}'>
<td>baz
</td></tr></tbody></table><meta typeof="mw:Annotation/translate/End" data-parsoid='{"wasMoved":true}' data-mw='{"wtOffsets":[21,33]}'/>
!!end

!!test
Translate getting roped into a template because of fostering should get the about attribute of the template
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
{{1x|Some text!
<table>
<tr>
<td>table</td></tr>}}
<translate><tr>
<td>stuff</td>
</tr></translate>
</table>
!! html/parsoid
<p about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"Some text!\n&lt;table>\n&lt;tr>\n&lt;td>table&lt;/td>&lt;/tr>"}},"i":0}},"\n&lt;translate>&lt;tr>\n&lt;td>stuff&lt;/td>\n&lt;/tr>&lt;/translate>\n&lt;/table>"]}'>Some text!</p><span about="#mwt1">
</span><meta typeof="mw:Annotation/translate" about="#mwt1" data-parsoid='{"dsr":[51,62,null,null],"wasMoved":true}' data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[51,62]}' /><table about="#mwt1" data-parsoid='{"stx":"html","dsr":[null,108,null,8]}'>
<tbody data-parsoid='{"dsr":[null,100,0,0]}'><tr data-parsoid='{"stx":"html"}'>
<td data-parsoid='{"stx":"html"}'>table</td></tr>
<tr data-parsoid='{"stx":"html","dsr":[62,87,4,5]}'>
<td data-parsoid='{"stx":"html","dsr":[67,81,4,5]}'>stuff</td>
</tr>
</tbody></table><meta typeof="mw:Annotation/translate/End" about="#mwt1" data-parsoid='{"dsr":[87,99,null,null],"wasMoved":true}' data-mw='{"wtOffsets":[87,99]}' />
!!end

!! test
Translate tags around <pre> area with new lines
!! wikitext
<translate>
 foo
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<pre>foo</pre>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[17,29]}'/>
!! end

!! test
Newlines should be inserted between annotation tags and pre
!!options
parsoid={
  "modes": ["html2wt"]
}
!! html/parsoid
foo<meta typeof="mw:Annotation/translate" /><pre>bar</pre><meta typeof="mw:Annotation/translate/End"/>baz
foo<pre>bar</pre>baz
!! wikitext
foo<translate>
 bar
</translate>baz
foo
 bar
baz
!! end

!! test
Translate tags in list items
!! wikitext
*<translate>List item!</translate>
!! html/parsoid
<ul data-parsoid='{"dsr":[0,35,0,0]}'><li data-parsoid='{"dsr":[0,35,1,0,1,0]}'><meta typeof="mw:Annotation/translate" data-parsoid='{"dsr":[1,12,null,null]}' data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[1,12]}'/>List item!<meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[22,34,null,null]}' data-mw='{"wtOffsets":[22,34]}'/></li></ul>
!! end


### Tests from annotation spec
!! test
1/ Whole content contained in annotation tags
!! wikitext
<translate>
One paragraph.

And another.
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<p>One paragraph.</p>

<p>And another.</p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[41,53]}'/>
!! end

!! test
2/ Extended annotation range
!! options
parsoid={
  "modes": ["wt2html", "selser","wt2wt"]
}
!! wikitext
This is ''an <translate>artificial'' '''example</translate> of''' extension.
!! html/parsoid
<p>This is <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[13,24]}'/><i>an artificial</i> <b>example of</b><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[47,59]}'/> extension.</p>
!! end

!! test
3/ Two types of annotation, nested; annotation attributes
!! wikitext
<translate>Some text <tvar name="myvar">with a variable</tvar> in the middle</translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>Some text <meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"myvar"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[21,40]}'/>with a variable<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[55,62]}'/> in the middle<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[76,88]}'/></p>
!! end

!! test
4/ Template (fully enclosed) in annotation range
!! wikitext
aa <translate>bb {{1x|some content}} bb</translate> aa
!! html/parsoid
<p>aa <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[3,14]}'/>bb <span about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"some content"}},"i":0}}]}'>some content</span> bb<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[39,51]}'/> aa</p>
!! end

!! test
5/ annotation (fully enclosed) in template
!! wikitext
{{1x|bb <translate>some content</translate> bb}} aa
!! html/parsoid
<p><span about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"bb &lt;translate>some content&lt;/translate> bb"}},"i":0}}]}'>bb </span><meta typeof="mw:Annotation/translate" about="#mwt1" data-mw='{"rangeId":"mwa0"}'/><span about="#mwt1">some content</span><meta typeof="mw:Annotation/translate/End" about="#mwt1" data-mw='{"rangeId":"mwa0"}'/><span about="#mwt1"> bb</span> aa</p>
!! end

!! test
7/ attributes in annotations
!! options
!! wikitext
{|
|-
| style="background: <translate>red</translate>; color: white;" |abc
|jkl
|}
!! html/parsoid
<table>
<tbody>
<tr data-parsoid='{"startTagSrc":"|-"}'>
<td style="background: red; color: white;" about="#mwt1" typeof="mw:ExpandedAttrs mw:Annotation/translate" data-parsoid='{"a":{"style":"background: red; color: white;"},"sa":{"style":"background: &lt;translate>red&lt;/translate>; color: white;"}}' data-mw='{"attribs":[[{"txt":"style"},{"html":"background: &lt;meta typeof=\"mw:Annotation/translate\" data-parsoid=&apos;{\"dsr\":[27,38,null,null]}&apos; data-mw=&apos;{\"rangeId\":\"mwa0\",\"extendedRange\":false,\"wtOffsets\":[27,38]}&apos;/>red&lt;meta typeof=\"mw:Annotation/translate/End\" data-parsoid=&apos;{\"dsr\":[41,53,null,null]}&apos; data-mw=&apos;{\"wtOffsets\":[41,53]}&apos;/>; color: white;"}]]}'>abc</td>
<td>jkl</td></tr>
</tbody></table>
!! end

!! test
8/ fostered annotation markers
!! options
parsoid={
  "modes": ["wt2html", "selser", "wt2wt"]
}
!! wikitext
{|
|table
|with
|-
<translate>
|some
|content
</translate>
|-
|translate
|one line
|}
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[19,30]}'/><table>
<tbody><tr data-parsoid='{"autoInsertedStart":true}'><td>table</td>
<td>with</td></tr>
<tr data-parsoid='{"startTagSrc":"|-"}'>

<td>some</td>
<td>content
</td></tr>
<tr data-parsoid='{"startTagSrc":"|-"}'>
<td>translate</td>
<td>one line</td></tr>
</tbody></table><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[46,58]}'/>
!!end

!! test
Selser: add a paragraph at the end of the content should not make the </translate> tag disappear
!! options
parsoid={
  "modes": ["selser"],
  "changes": [
    ["p", "after", "<p>plop</p>"]
  ]
}
!! wikitext
<translate>
==plop==

Add another paragraph.
</translate>
!! wikitext/edited
<translate>
==plop==

Add another paragraph.

plop
</translate>
!!end 

!! test
Selser: add content at the end of a paragraph with badly nested content with annotation
!! options
parsoid={
  "modes": ["selser"],
  "changes": [
    ["p", "append", "something"]
  ]
}
!!wikitext
Some ''stuff <translate>and '''also some'' more</translate> stuff''' than that.
!! wikitext/edited
Some ''stuff <translate>and '''also some'' more</translate> stuff''' than that.something
!! end

!! test
Selser: add content at the end of a paragraph with badly nested content without annotation
!! wikitext
Some ''stuff and '''also some'' more stuff''' than that.
!!html/parsoid
<p>Some <i>stuff and <b>also some</b></i><b> more stuff</b> than that.</p>
!! end

!!test
Selser: add content in a cell of a table where translate gets fostered out should keep the annotation around the table
!! options
parsoid={
  "modes": ["selser"],
  "changes": [
    ["tr > td:first-child", "text", "plop"]
  ]
}
!!wikitext
{|
|-
|a
|b
|-
<translate>
|c
|d</translate>
|-
|e
|f
|}
!!wikitext/edited
<translate>
{|
|-
|plop
|b
|-

|plop
|d
|-
|plop
|f
|}
</translate>
!!end

!! test
Selser: add content before and after <translate> and </translate> tags should keep paragraphs
!! options
parsoid={
	"modes": ["selser"],
	"changes": [
		["meta", "before", "<p>plop</p>"],
		["meta", "after", "<p>plop2</p>"]
	]
}
!!wikitext
<translate>
hello
</translate>
!! wikitext/edited
plop

<translate>
plop2

hello

plop
</translate>

plop2
!! end

!! test
Selser: add content before <translate> and </translate> tags should keep paragraphs
!! options
parsoid={
        "modes": ["selser"],
        "changes": [
                ["meta", "before", "<p>plop</p>"]
        ]
}
!!wikitext
<translate>
hello
</translate>
!! wikitext/edited
plop

<translate>
hello

plop
</translate>
!! end

!! test
Selser: add content after <translate> and </translate> tags should keep paragraphs
!! options
parsoid={
        "modes": ["selser"],
        "changes": [
                ["meta", "after", "<p>plop2</p>"]
        ]
}
!!wikitext
<translate>
hello
</translate>
!! wikitext/edited
<translate>
plop2

hello
</translate>

plop2
!! end

!!test
Selser: add headings after <translate> and </translate> tags should yield the right amount of new lines
!!options
parsoid={
        "modes": ["selser"],
        "changes": [
                ["meta", "after", "<h2>plop</h2>"]
        ]
}

!!wikitext
==title==
some paragraph

<translate>
hello
</translate>

some other paragraph
!!wikitext/edited
==title==
some paragraph

<translate>
== plop ==
hello
</translate>

== plop ==

some other paragraph
!! end

!!test
Selser: add headings before <translate> and </translate> tags should yield the right amount of new lines
!!options
parsoid={
        "modes": ["selser","wt2wt"],
        "changes": [
                ["meta", "before", "<h2>plop</h2>"]
        ]
}

!!wikitext
==title==
some paragraph

<translate>
hello
</translate>

some other paragraph
!!wikitext/edited
==title==
some paragraph

== plop ==

<translate>
hello

== plop ==
</translate>

some other paragraph
!! end

!!test
Selser: add lists before <translate> and </translate> tags should yield the right amount of new lines
!!options
parsoid={
        "modes": ["selser"],
        "changes": [
                ["meta", "before", "<ul><li>plop</li></ul>"]
        ]
}
!!wikitext
==title==
some paragraph

<translate>
hello
</translate>

some other paragraph
!!wikitext/edited
==title==
some paragraph

* plop

<translate>
hello

* plop
</translate>

some other paragraph
!!end

!!test
Selser: add lists after <translate> and </translate> tags should yield the right amount of new lines
!!options
parsoid={
        "modes": ["selser"],
        "changes": [
                ["meta", "after", "<ul><li>plop</li></ul>"]
        ]
}
!!wikitext
==title==
some paragraph

<translate>
hello
</translate>

some other paragraph
!!wikitext/edited
==title==
some paragraph

<translate>
* plop

hello
</translate>

* plop

some other paragraph
!!end

!! test
T295330 - dsr computation should allow proper selser
!! wikitext
<translate>
<!--T:1-->
'''The quick brown fox jumps over the lazy dog.'''
</translate>

[[Category:Foo]]
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<!--T:1-->
<p><b>The quick brown fox jumps over the lazy dog.</b></p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[74,86]}'/>

<link rel="mw:PageProp/Category" href="./Category:Foo" data-parsoid='{"stx":"simple","a":{"href":"./Category:Foo"},"sa":{"href":"Category:Foo"}}'/>
!! end

## FIXME: This is currently awkward where only the start of the translate is pulled into the template range.
## This doesn't affect correctness because the ranges are all marked extended (because of bad nesting).
## But, the bad nesting is an artefact of how the paragraph wrapper leaves the opening and closing meta
## tags of the annotation range in different paragraphs, and one of those paragraphs happen to be from
## a template. If the p-wrapper can be tweaked to be smarter about this, this will get cleaned up better.
## But, for now, the focus is on not breaking selser.
!! test
When metas are migrated out of p-tags, template continuity should not be broken
!! options
parsoid=wt2html,selser
!! wikitext
{{1x|<div>a</div> b}}
<translate>
c
</translate>
!! html/parsoid
<div about="#mwt1" typeof="mw:Transclusion" data-parsoid='{"stx":"html","dsr":[0,33,null,null],"pi":[[{"k":"1"}]]}' data-mw='{"parts":[{"template":{"target":{"wt":"1x","href":"./Template:1x"},"params":{"1":{"wt":"&lt;div>a&lt;/div> b"}},"i":0}},"\n&lt;translate>"]}'>a</div><meta typeof="mw:Annotation/translate" about="#mwt1" data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[22,33]}'/><p about="#mwt1"> b
</p>
<p data-parsoid='{"dsr":[34,35,0,0]}'>c</p>
<meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[36,48,null,null]}' data-mw='{"wtOffsets":[36,48]}'/>
!! end

!! test
Old tvar syntax should not break too hard.
!! options
# html2wt and wt2wt are expected to break because we serialize to new syntax.
# html2html breaks because the wtOffsets break.
parsoid={
	"modes": ["wt2html", "selser"]
}
!! wikitext
<translate><tvar|plop>pouet</></translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/><meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"plop"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[11,22]}'/>pouet<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[27,30]}'/><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[30,42]}'/></p>
!! end

!! test
Old tvar syntax should not pull content in cell attributes
!! options
# html2wt and wt2wt are expected to break because we serialize to new syntax.
# html2html breaks because the wtOffsets break.
parsoid={
        "modes": ["wt2html", "selser"]
}
!! wikitext
{|
|<translate>hello <tvar|var>variable</></translate>
|}
!! html/parsoid
<table>
<tbody><tr data-parsoid='{"autoInsertedStart":true}'><td><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[4,15]}'/>hello <meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"var"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[21,31]}'/>variable<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[39,42]}'/><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[42,54]}'/></td></tr>
</tbody></table>
!! end

!! test
Annotations should not be hoisted out of headers
!! wikitext
==<translate><!--T:19--> Organizational and Planning Projects</translate>==
!! html/parsoid
<h2 id="Organizational_and_Planning_Projects"><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[2,13]}'/><!--T:19--> Organizational and Planning Projects<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[61,73]}'/></h2>
!! end

# Fixing T296169 in an imperfect way - see AnnotationDOMRangeBuilder.php#removeNestedRanges for details
# This test purposefully fails on wt2wt, but we want to keep the output as part of the tests results.
# Selser failures are also due to the wt2wt discrepancy.
!! test
T296169: Nested annotations should be dropped in HTML output
!! options
parsoid={
        "modes": ["wt2html", "selser", "wt2wt"]
}
!! wikitext
<translate><translate>t1</translate></translate> <translate>t2</translate> <translate><tvar name="plop">t3</tvar></translate>
!! html/parsoid
<p><meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>t1<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[36,48]}'/> <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa2","extendedRange":false,"wtOffsets":[49,60]}'/>t2<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[62,74]}'/> <meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa3","extendedRange":false,"wtOffsets":[75,86]}'/><meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"plop"},"rangeId":"mwa4","extendedRange":false,"wtOffsets":[86,104]}'/>t3<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[106,113]}'/><meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[113,125]}'/></p>
!! end

# T296169
!! test
T296169: Extended annotations that yield a nested annotation should not nest said annotation
!! options
parsoid={
        "modes": ["wt2html", "selser", "wt2wt"]
}
!! wikitext
a ''<translate>b'' c ''d </translate> e <translate>f</translate>'' g
!! html/parsoid
<p>a <meta typeof="mw:Annotation/translate" data-parsoid='{"wasMoved":true}' data-mw='{"rangeId":"mwa0","extendedRange":true,"wtOffsets":[4,15]}'/><i>b</i> c <i>d e f</i><meta typeof="mw:Annotation/translate/End" data-parsoid='{"wasMoved":true}' data-mw='{"wtOffsets":[25,37]}'/> g</p>
!! end

!! test
Annotation markers starting lines should neither insert pre nor merge ranges
!! wikitext
<translate><!--T:1--> translate 1</translate>
<translate><!--T:2--> translate 2</translate>
!! html/parsoid
<p data-parsoid='{"dsr":[0,91,0,0]}'><meta typeof="mw:Annotation/translate" data-parsoid='{"dsr":[0,11,null,null]}' data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/><!--T:1--> translate 1<meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[33,45,null,null]}' data-mw='{"wtOffsets":[33,45]}'/>
<meta typeof="mw:Annotation/translate" data-parsoid='{"dsr":[46,57,null,null]}' data-mw='{"rangeId":"mwa1","extendedRange":false,"wtOffsets":[46,57]}'/><!--T:2--> translate 2<meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[79,91,null,null]}' data-mw='{"wtOffsets":[79,91]}'/></p>
!! end

!! test
# This is not correct yet because the template is not expanded in the HTML - the template is considered as a raw string
# instead. Follow-up as T299523.
Annotations with templated annotation attribute shouldn't emit a warning and should round-trip
!! wikitext
<translate>
<tvar {{1x|1="name=hello other=plop nowrap"}}>test</tvar>
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-parsoid='{"dsr":[0,11,null,null]}' data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<p data-parsoid='{"dsr":[12,69,0,0]}'><meta typeof="mw:Annotation/tvar" data-parsoid='{"dsr":[12,58,null,null]}' data-mw='{"attrs":{"{{1x|1=\"name=hello other=plop nowrap\"}}":""},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[12,58]}'/>test<meta typeof="mw:Annotation/tvar/End" data-parsoid='{"dsr":[62,69,null,null]}' data-mw='{"wtOffsets":[62,69]}'/></p>
<meta typeof="mw:Annotation/translate/End" data-parsoid='{"dsr":[70,82,null,null]}' data-mw='{"wtOffsets":[70,82]}'/>
!! end

!! test
Annotations with templated annotation attribute name shouldn't emit a warning and should round-trip
!! wikitext
<translate>
<tvar {{1x|name}}="hello">test</tvar>
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<p><meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"{{1x|name}}":"hello"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[12,38]}'/>test<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[42,49]}'/></p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[50,62]}'/>
!! end

!! test
Annotations with templated annotation attribute value shouldn't emit a warning and should round-trip
!! wikitext
<translate>
<tvar name="{{1x|hello}}">test</tvar>
</translate>
!! html/parsoid
<meta typeof="mw:Annotation/translate" data-mw='{"rangeId":"mwa0","extendedRange":false,"wtOffsets":[0,11]}'/>
<p><meta typeof="mw:Annotation/tvar" data-mw='{"attrs":{"name":"{{1x|hello}}"},"rangeId":"mwa1","extendedRange":false,"wtOffsets":[12,38]}'/>test<meta typeof="mw:Annotation/tvar/End" data-mw='{"wtOffsets":[42,49]}'/></p>
<meta typeof="mw:Annotation/translate/End" data-mw='{"wtOffsets":[50,62]}'/>
!! end